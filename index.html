<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PCI Helper Client App</title>

  <!-- Genesys Client App SDK -->
  <script src="https://apps.mypurecloud.com/client-apps/sdk/purecloud-client-app-sdk.js"></script>

  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' https://apps.mypurecloud.com 'unsafe-inline';
          connect-src 'self' https://YOUR-BACKEND;
        ">
</head>

<body>
<script>
  /**
   * CONFIGURATION
   * Update these for your environment
   */

  // EXACT origin of the wrapper page (no trailing slash)
  const ALLOWED_ORIGINS = [
    'https://dimitri303.github.io'
  ];

  // Backend endpoint that:
  // - creates / resumes PCI Pal session
  // - establishes secure IVR leg in Genesys
  // - returns { sid, bt, rt }
  const BACKEND_START_URL = 'https://YOUR-BACKEND/start-pci-session';

  // Backend call timeout
  const BACKEND_TIMEOUT_MS = 10000;

  /**
   * Initialise the Genesys Client App
   */
  const clientApp = new window.purecloud.apps.ClientApp({
    pcEnvironment: 'euwest2' // adjust if required
  });

  clientApp.lifecycle.ready
    .then(() => console.log('PCI Helper Client App ready'))
    .catch(err => console.error('Client App lifecycle error', err));

  /**
   * Listen for messages from the wrapper iframe
   */
  window.addEventListener('message', async (event) => {

    // Origin validation
    if (!event || !event.origin || !ALLOWED_ORIGINS.includes(event.origin)) {
      return;
    }

    // Validate message
    if (!event.data || event.data.type !== 'START_PCI_PAYMENT') return;
    if (!event.source) return;

    const reply = (payload) => {
      try {
        event.source.postMessage(payload, event.origin);
      } catch (e) {
        console.error('postMessage failed', e);
      }
    };

    // Inform wrapper we're starting
    reply({ type: 'PCI_SESSION_STARTING' });

    try {
      // Get the active interaction
      const interaction = await clientApp.interaction.getInteraction();

      if (!interaction || !interaction.id) {
        throw new Error('No active interaction found');
      }

      const conversationId = interaction.id;
      console.log('Starting PCI for conversation', conversationId);

      // Backend call with timeout
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), BACKEND_TIMEOUT_MS);

      const response = await fetch(BACKEND_START_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ conversationId }),
        signal: controller.signal
      });

      clearTimeout(timer);

      if (!response.ok) {
        throw new Error('Backend failed to start PCI session');
      }

      const data = await response.json();

      if (!data || !data.sid || !data.bt || !data.rt) {
        throw new Error('Backend returned incomplete PCI session data');
      }

      // Send session details back to wrapper
      reply({
        type: 'PCI_SESSION_READY',
        sid: data.sid,
        bt: data.bt,
        rt: data.rt
      });

    } catch (err) {
      console.error('PCI start failed', err);

      reply({
        type: 'PCI_SESSION_ERROR',
        message: err.name === 'AbortError'
          ? 'PCI start timed out'
          : err.message || 'PCI start failed'
      });
    }
  });
</script>
</body>
</html>
